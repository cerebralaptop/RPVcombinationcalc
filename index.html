<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Responsible Products Calculator</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, sans-serif;
    }

    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useCallback, useEffect } = React;

    // ==================== DATA ====================
    // Data URLs - update these CSVs in GitHub to change the calculator
    const DATA_URLS = {
      initiatives: 'https://raw.githubusercontent.com/jochapam/RPVtest1234/main/initiative_list.csv',
      combinations: 'https://raw.githubusercontent.com/jochapam/RPVtest1234/main/RPV_combinations_data.csv',
    };

    // Will be populated from CSV
    let INITIATIVES = [];
    let COMBINATIONS_DATA = {};

    // Category configurations (from Excel)
    const CATEGORIES = {
      structure: {
        name: "Responsible Structure",
        column: "Responsible Structure",
        benchmarks: {
          creditAchievement: { requirement: "Good practice", benchmark: 0.3, points: 2 },
          exceptionalA: { requirement: "Best practice", benchmark: 0.1, points: 2 },
          exceptionalB: { requirement: "Good practice", benchmark: 0.6, points: 2 },
          leadership: { requirement: "Best practice", benchmark: "EP A & B", points: 1 },
        },
      },
      envelope: {
        name: "Responsible Envelope",
        column: "Responsible Envelope",
        benchmarks: {
          creditAchievement: { requirement: "Good practice", benchmark: 0.3, points: 2 },
          exceptionalA: { requirement: "Best practice", benchmark: 0.1, points: 2 },
          exceptionalB: { requirement: "Good practice", benchmark: 0.6, points: 2 },
          leadership: { requirement: "Best practice", benchmark: "EP A & B", points: 1 },
        },
      },
      systems: {
        name: "Responsible Systems",
        column: "Responsible Systems",
        benchmarks: {
          creditAchievement: { requirement: "Good practice", benchmark: 0.4, points: 1 },
          exceptionalA: { requirement: "Best practice", benchmark: 0.1, points: 1 },
          exceptionalB: { requirement: "Good practice", benchmark: 0.6, points: 1 },
          leadership: { requirement: "Best practice", benchmark: "EP A & B", points: 1 },
        },
      },
      finishes: {
        name: "Responsible Finishes",
        column: "Responsible Finishes",
        benchmarks: {
          creditAchievement: { requirement: "Good practice", benchmark: 0.5, points: 3 },
          exceptionalA: { requirement: "Best practice", benchmark: 0.1, points: 2 },
          exceptionalB: { requirement: "Good practice", benchmark: 0.8, points: 2 },
          leadership: { requirement: "Best practice", benchmark: "EP A & B", points: 1 },
        },
      },
    };


    // ==================== COMPONENTS ====================

    const Tabs = ({ activeTab, onTabChange }) => {
      const tabs = Object.entries(CATEGORIES);

      return (
        <div className="border-b border-gray-200">
          <nav className="flex flex-wrap -mb-px">
            {tabs.map(([key, cat]) => (
              <button
                key={key}
                onClick={() => onTabChange(key)}
                className={`py-3 px-4 text-sm font-medium border-b-2 transition-colors ${
                  activeTab === key
                    ? 'border-green-600 text-green-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
              >
                {cat.name}
              </button>
            ))}
          </nav>
        </div>
      );
    };

    const ResultsPanel = ({ category, products, totalCost }) => {
      const config = CATEGORIES[category];
      const column = config.column;

      const { goodPracticeCost, bestPracticeCost } = useMemo(() => {
        let good = 0;
        let best = 0;

        products.forEach(p => {
          if (p.tier === 'Good practice') {
            good += p.cost || 0;
          } else if (p.tier === 'Best practice') {
            best += p.cost || 0;
          }
        });

        return { goodPracticeCost: good, bestPracticeCost: best };
      }, [products]);

      const goodPracticePercent = totalCost > 0 ? goodPracticeCost / totalCost : 0;
      const bestPracticePercent = totalCost > 0 ? bestPracticeCost / totalCost : 0;

      // Combined good practice includes best practice products
      const combinedGoodPercent = totalCost > 0 ? (goodPracticeCost + bestPracticeCost) / totalCost : 0;

      // Calculate points
      const creditAchievement = combinedGoodPercent >= config.benchmarks.creditAchievement.benchmark
        ? config.benchmarks.creditAchievement.points : 0;

      const exceptionalA = bestPracticePercent >= config.benchmarks.exceptionalA.benchmark
        ? config.benchmarks.exceptionalA.points : 0;

      const exceptionalB = combinedGoodPercent >= config.benchmarks.exceptionalB.benchmark
        ? config.benchmarks.exceptionalB.points : 0;

      const leadership = (exceptionalA > 0 && exceptionalB > 0)
        ? config.benchmarks.leadership.points : 0;

      const totalPoints = creditAchievement + exceptionalA + exceptionalB + leadership;

      const formatCurrency = (val) => `$${val.toLocaleString('en-AU', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
      const formatPercent = (val) => `${(val * 100).toFixed(1)}%`;

      return (
        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h3 className="text-lg font-semibold text-gray-800 mb-4">Results</h3>

          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div className="bg-gray-50 rounded-lg p-4">
              <div className="text-sm text-gray-500">Good Practice Cost</div>
              <div className="text-xl font-bold text-gray-800">{formatCurrency(goodPracticeCost + bestPracticeCost)}</div>
              <div className="text-sm text-green-600 font-medium">{formatPercent(combinedGoodPercent)}</div>
            </div>
            <div className="bg-gray-50 rounded-lg p-4">
              <div className="text-sm text-gray-500">Best Practice Cost</div>
              <div className="text-xl font-bold text-gray-800">{formatCurrency(bestPracticeCost)}</div>
              <div className="text-sm text-green-600 font-medium">{formatPercent(bestPracticePercent)}</div>
            </div>
            <div className="bg-gray-50 rounded-lg p-4">
              <div className="text-sm text-gray-500">Total Cost</div>
              <div className="text-xl font-bold text-gray-800">{formatCurrency(totalCost)}</div>
            </div>
            <div className="bg-green-50 rounded-lg p-4">
              <div className="text-sm text-green-700">Total Points</div>
              <div className="text-2xl font-bold text-green-700">{totalPoints}</div>
            </div>
          </div>

          <div className="border-t pt-4">
            <h4 className="text-sm font-semibold text-gray-700 mb-3">Credit Criteria</h4>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between items-center py-2 border-b">
                <div>
                  <span className="font-medium">Credit Achievement</span>
                  <span className="text-gray-500 ml-2">
                    (Good practice ≥ {(config.benchmarks.creditAchievement.benchmark * 100)}%)
                  </span>
                </div>
                <div className={`font-bold ${creditAchievement > 0 ? 'text-green-600' : 'text-gray-400'}`}>
                  {creditAchievement} pts
                </div>
              </div>
              <div className="flex justify-between items-center py-2 border-b">
                <div>
                  <span className="font-medium">Exceptional Performance A</span>
                  <span className="text-gray-500 ml-2">
                    (Best practice ≥ {(config.benchmarks.exceptionalA.benchmark * 100)}%)
                  </span>
                </div>
                <div className={`font-bold ${exceptionalA > 0 ? 'text-green-600' : 'text-gray-400'}`}>
                  {exceptionalA} pts
                </div>
              </div>
              <div className="flex justify-between items-center py-2 border-b">
                <div>
                  <span className="font-medium">Exceptional Performance B</span>
                  <span className="text-gray-500 ml-2">
                    (Good practice ≥ {(config.benchmarks.exceptionalB.benchmark * 100)}%)
                  </span>
                </div>
                <div className={`font-bold ${exceptionalB > 0 ? 'text-green-600' : 'text-gray-400'}`}>
                  {exceptionalB} pts
                </div>
              </div>
              <div className="flex justify-between items-center py-2">
                <div>
                  <span className="font-medium">Leadership Challenge</span>
                  <span className="text-gray-500 ml-2">(EP A & B achieved)</span>
                </div>
                <div className={`font-bold ${leadership > 0 ? 'text-green-600' : 'text-gray-400'}`}>
                  {leadership} pts
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const ProductRow = ({ product, index, category, onUpdate, onRemove }) => {
      const tierColor = {
        'Best practice': 'bg-green-100 text-green-800',
        'Good practice': 'bg-blue-100 text-blue-800',
        'Tier not met': 'bg-yellow-100 text-yellow-800',
        'Not recognised': 'bg-red-100 text-red-800',
      };

      return (
        <tr className="border-b hover:bg-gray-50">
          <td className="py-3 px-2">
            <input
              type="text"
              value={product.manufacturer}
              onChange={(e) => onUpdate(index, 'manufacturer', e.target.value)}
              className="w-full px-2 py-1 border rounded text-sm"
              placeholder="Manufacturer"
            />
          </td>
          <td className="py-3 px-2">
            <input
              type="text"
              value={product.productName}
              onChange={(e) => onUpdate(index, 'productName', e.target.value)}
              className="w-full px-2 py-1 border rounded text-sm"
              placeholder="Product name"
            />
          </td>
          <td className="py-3 px-2">
            <input
              type="number"
              value={product.cost || ''}
              onChange={(e) => onUpdate(index, 'cost', parseFloat(e.target.value) || 0)}
              className="w-full px-2 py-1 border rounded text-sm text-right"
              placeholder="0"
              min="0"
            />
          </td>
          <td className="py-3 px-2">
            <select
              value={product.initiative1}
              onChange={(e) => onUpdate(index, 'initiative1', e.target.value)}
              className="w-full px-2 py-1 border rounded text-sm bg-white"
            >
              <option value="">-- Select --</option>
              {INITIATIVES.map(init => (
                <option key={init} value={init}>{init}</option>
              ))}
            </select>
          </td>
          <td className="py-3 px-2">
            <select
              value={product.initiative2}
              onChange={(e) => onUpdate(index, 'initiative2', e.target.value)}
              className="w-full px-2 py-1 border rounded text-sm bg-white"
            >
              <option value="">-- None --</option>
              {INITIATIVES.filter(i => i !== product.initiative1).map(init => (
                <option key={init} value={init}>{init}</option>
              ))}
            </select>
          </td>
          <td className="py-3 px-2 text-center">
            <span className={`inline-block px-2 py-1 rounded text-xs font-medium ${tierColor[product.tier] || 'bg-gray-100 text-gray-600'}`}>
              {product.tier || 'Select initiatives'}
            </span>
          </td>
          <td className="py-3 px-2 text-center">
            <button
              onClick={() => onRemove(index)}
              className="text-red-500 hover:text-red-700 p-1"
              title="Remove product"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </td>
        </tr>
      );
    };

    const ProductsTable = ({ category, products, onProductsChange }) => {
      const config = CATEGORIES[category];

      const lookupTier = useCallback((init1, init2) => {
        if (!init1) return '';

        const column = config.column;

        // Try single initiative first
        if (!init2) {
          const tier = COMBINATIONS_DATA[init1]?.[column];
          if (tier) return tier;
          return 'Not recognised';
        }

        // Try combination (both orders)
        const combo1 = `${init1} + ${init2}`;
        const combo2 = `${init2} + ${init1}`;

        let tier = COMBINATIONS_DATA[combo1]?.[column];
        if (tier) return tier;

        tier = COMBINATIONS_DATA[combo2]?.[column];
        if (tier) return tier;

        return 'Not recognised';
      }, [config.column]);

      const updateProduct = useCallback((index, field, value) => {
        const newProducts = [...products];
        newProducts[index] = { ...newProducts[index], [field]: value };

        // Recalculate tier if initiatives changed
        if (field === 'initiative1' || field === 'initiative2') {
          const p = newProducts[index];
          newProducts[index].tier = lookupTier(p.initiative1, p.initiative2);
        }

        onProductsChange(newProducts);
      }, [products, onProductsChange, lookupTier]);

      const removeProduct = useCallback((index) => {
        const newProducts = products.filter((_, i) => i !== index);
        onProductsChange(newProducts);
      }, [products, onProductsChange]);

      const addProduct = useCallback(() => {
        onProductsChange([
          ...products,
          { manufacturer: '', productName: '', cost: 0, initiative1: '', initiative2: '', tier: '' }
        ]);
      }, [products, onProductsChange]);

      return (
        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
          <div className="p-4 border-b flex justify-between items-center">
            <h3 className="text-lg font-semibold text-gray-800">Products</h3>
            <button
              onClick={addProduct}
              className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
              </svg>
              Add Product
            </button>
          </div>

          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-gray-50">
                <tr>
                  <th className="py-3 px-2 text-left font-medium text-gray-600">Manufacturer</th>
                  <th className="py-3 px-2 text-left font-medium text-gray-600">Product Name</th>
                  <th className="py-3 px-2 text-right font-medium text-gray-600 w-28">Cost ($)</th>
                  <th className="py-3 px-2 text-left font-medium text-gray-600">Initiative 1</th>
                  <th className="py-3 px-2 text-left font-medium text-gray-600">Initiative 2</th>
                  <th className="py-3 px-2 text-center font-medium text-gray-600 w-32">Tier</th>
                  <th className="py-3 px-2 text-center font-medium text-gray-600 w-16"></th>
                </tr>
              </thead>
              <tbody>
                {products.length === 0 ? (
                  <tr>
                    <td colSpan={7} className="py-8 text-center text-gray-500">
                      No products added yet. Click "Add Product" to get started.
                    </td>
                  </tr>
                ) : (
                  products.map((product, index) => (
                    <ProductRow
                      key={index}
                      product={product}
                      index={index}
                      category={category}
                      onUpdate={updateProduct}
                      onRemove={removeProduct}
                    />
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      );
    };

    const CategoryPanel = ({ category, data, onDataChange }) => {
      const config = CATEGORIES[category];

      return (
        <div className="space-y-6">
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h3 className="text-lg font-semibold text-gray-800 mb-4">Total Costs</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Total cost of all {config.name.toLowerCase()} components
                </label>
                <div className="relative">
                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                  <input
                    type="number"
                    value={data.totalCost || ''}
                    onChange={(e) => onDataChange({ ...data, totalCost: parseFloat(e.target.value) || 0 })}
                    className="w-full pl-8 pr-4 py-2 border rounded-lg text-right"
                    placeholder="0"
                    min="0"
                  />
                </div>
              </div>
              <div className="flex items-end">
                <label className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={data.includesLabour || false}
                    onChange={(e) => onDataChange({ ...data, includesLabour: e.target.checked })}
                    className="w-4 h-4 rounded border-gray-300 text-green-600 focus:ring-green-500"
                  />
                  <span className="text-sm text-gray-700">Calculated costs include labour</span>
                </label>
              </div>
            </div>
          </div>

          <ResultsPanel
            category={category}
            products={data.products}
            totalCost={data.totalCost || 0}
          />

          <ProductsTable
            category={category}
            products={data.products}
            onProductsChange={(products) => onDataChange({ ...data, products })}
          />
        </div>
      );
    };

    // ==================== MAIN APP ====================
    function App() {
      const [activeTab, setActiveTab] = useState('structure');
      const [dataLoaded, setDataLoaded] = useState(false);
      const [loadError, setLoadError] = useState(null);

      // Data for each category
      const [categoryData, setCategoryData] = useState({
        structure: { totalCost: 0, includesLabour: false, products: [] },
        envelope: { totalCost: 0, includesLabour: false, products: [] },
        systems: { totalCost: 0, includesLabour: false, products: [] },
        finishes: { totalCost: 0, includesLabour: false, products: [] },
      });

      // Load data from GitHub CSVs
      useEffect(() => {
        const parseCSVLine = (line) => {
          const values = [];
          let current = '';
          let inQuotes = false;

          for (const char of line) {
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              values.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
          values.push(current.trim());
          return values;
        };

        const loadData = async () => {
          try {
            // Load both CSVs in parallel
            const [initiativesRes, combinationsRes] = await Promise.all([
              fetch(DATA_URLS.initiatives),
              fetch(DATA_URLS.combinations),
            ]);

            // Parse initiatives list
            const initiativesText = await initiativesRes.text();
            const initiativeLines = initiativesText.split('\n');
            INITIATIVES = [];
            for (let i = 1; i < initiativeLines.length; i++) {
              const line = initiativeLines[i]?.replace(/["\ufeff]/g, '').trim();
              if (line) {
                INITIATIVES.push(line);
              }
            }

            // Parse combinations data
            const combinationsText = await combinationsRes.text();
            const lines = combinationsText.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/["\ufeff]/g, '').trim());

            COMBINATIONS_DATA = {};
            for (let i = 1; i < lines.length; i++) {
              const line = lines[i];
              if (!line.trim()) continue;

              const values = parseCSVLine(line);
              const initiative = values[0]?.replace(/["\ufeff]/g, '').trim();
              if (initiative) {
                COMBINATIONS_DATA[initiative] = {
                  [headers[1]]: values[1]?.trim() || '',
                  [headers[2]]: values[2]?.trim() || '',
                  [headers[3]]: values[3]?.trim() || '',
                  [headers[4]]: values[4]?.trim() || '',
                };
              }
            }

            setDataLoaded(true);
          } catch (err) {
            console.error('Failed to load data:', err);
            setLoadError(err.message);
          }
        };

        loadData();
      }, []);

      const handleCategoryDataChange = useCallback((category, data) => {
        setCategoryData(prev => ({ ...prev, [category]: data }));
      }, []);

      // File input ref for import
      const fileInputRef = React.useRef(null);

      // Export to Excel
      const handleExport = useCallback(() => {
        const wb = XLSX.utils.book_new();

        // Sheet name mapping
        const sheetNames = {
          structure: 'Responsible Structure',
          envelope: 'Responsible Envelope',
          systems: 'Responsible Systems',
          finishes: 'Responsible Finishes & Joinery',
        };

        Object.entries(categoryData).forEach(([key, data]) => {
          const config = CATEGORIES[key];
          const products = data.products || [];

          // Calculate results
          let goodCost = 0, bestCost = 0;
          products.forEach(p => {
            if (p.tier === 'Good practice') goodCost += p.cost || 0;
            else if (p.tier === 'Best practice') bestCost += p.cost || 0;
          });

          const totalCost = data.totalCost || 0;
          const goodPercent = totalCost > 0 ? (goodCost + bestCost) / totalCost : 0;
          const bestPercent = totalCost > 0 ? bestCost / totalCost : 0;

          // Build sheet data
          const sheetData = [
            [sheetNames[key]],
            [],
            ['Total costs'],
            ['Total cost of all components', '', totalCost],
            ['Calculated costs include labour', '', data.includesLabour ? 'Yes' : 'No'],
            [],
            ['Results'],
            ['Total cost of good practice products', '', goodCost + bestCost],
            ['Good practice products (%)', '', (goodPercent * 100).toFixed(1) + '%'],
            ['Total cost of best practice products', '', bestCost],
            ['Best practice products (%)', '', (bestPercent * 100).toFixed(1) + '%'],
            [],
            ['Products'],
            ['Manufacturer', 'Product name', 'Cost ($)', 'Recognised initiative 1', 'Recognised initiative 2', 'Tier'],
          ];

          // Add product rows
          products.forEach(p => {
            sheetData.push([
              p.manufacturer || '',
              p.productName || '',
              p.cost || 0,
              p.initiative1 || '',
              p.initiative2 || '',
              p.tier || '',
            ]);
          });

          // Add empty rows for future entries
          for (let i = 0; i < 10; i++) {
            sheetData.push(['', '', '', '', '', '']);
          }

          const ws = XLSX.utils.aoa_to_sheet(sheetData);

          // Set column widths
          ws['!cols'] = [
            { wch: 30 }, { wch: 30 }, { wch: 12 },
            { wch: 50 }, { wch: 50 }, { wch: 15 },
          ];

          XLSX.utils.book_append_sheet(wb, ws, sheetNames[key]);
        });

        // Download
        XLSX.writeFile(wb, 'Responsible_Products_Calculator.xlsx');
      }, [categoryData]);

      // Import from Excel
      const handleImport = useCallback((event) => {
        const file = event.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });

            // Sheet name mapping (reverse)
            const sheetKeyMap = {
              'Responsible Structure': 'structure',
              'Responsible Envelope': 'envelope',
              'Responsible Systems': 'systems',
              'Responsible Finishes & Joinery': 'finishes',
              'Responsible Finishes': 'finishes',
              'Responsible Partitions': 'structure',
              'Responsible Furniture': 'systems',
              'Responsible Equipment & Fixture': 'envelope',
              'Responsible Equipment & Fixtures': 'envelope',
            };

            const newCategoryData = { ...categoryData };

            wb.SheetNames.forEach(sheetName => {
              const categoryKey = sheetKeyMap[sheetName];
              if (!categoryKey) return;

              const ws = wb.Sheets[sheetName];
              const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });

              let totalCost = 0;
              let includesLabour = false;
              const products = [];

              // Find total cost and labour rows
              let inProductsSection = false;
              let headerRowIndex = -1;

              rows.forEach((row, idx) => {
                const firstCell = String(row[0] || '').toLowerCase().trim();

                // Look for total cost
                if (firstCell.includes('total cost of all')) {
                  totalCost = parseFloat(row[2]) || 0;
                }

                // Look for labour
                if (firstCell.includes('labour')) {
                  includesLabour = String(row[2] || '').toLowerCase().includes('yes');
                }

                // Detect products header row
                if (firstCell === 'manufacturer') {
                  inProductsSection = true;
                  headerRowIndex = idx;
                  return;
                }

                // Parse product rows
                if (inProductsSection && headerRowIndex >= 0 && idx > headerRowIndex) {
                  const manufacturer = String(row[0] || '').trim();
                  const productName = String(row[1] || '').trim();
                  const cost = parseFloat(row[2]) || 0;
                  const initiative1 = String(row[3] || '').trim();
                  const initiative2 = String(row[4] || '').trim();

                  if (manufacturer || productName || cost > 0 || initiative1) {
                    // Lookup tier
                    let tier = '';
                    const column = CATEGORIES[categoryKey]?.column;
                    if (initiative1 && column) {
                      if (!initiative2) {
                        tier = COMBINATIONS_DATA[initiative1]?.[column] || 'Not recognised';
                      } else {
                        const combo1 = `${initiative1} + ${initiative2}`;
                        const combo2 = `${initiative2} + ${initiative1}`;
                        tier = COMBINATIONS_DATA[combo1]?.[column] || COMBINATIONS_DATA[combo2]?.[column] || 'Not recognised';
                      }
                    }

                    products.push({
                      manufacturer,
                      productName,
                      cost,
                      initiative1,
                      initiative2,
                      tier,
                    });
                  }
                }
              });

              newCategoryData[categoryKey] = {
                totalCost,
                includesLabour,
                products,
              };
            });

            setCategoryData(newCategoryData);
            alert('Excel file imported successfully!');
          } catch (err) {
            console.error('Import error:', err);
            alert('Failed to import Excel file. Please check the format.');
          }
        };
        reader.readAsArrayBuffer(file);

        // Reset file input
        event.target.value = '';
      }, [categoryData]);

      if (loadError) {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-lg p-8 max-w-md text-center">
              <div className="text-red-500 text-5xl mb-4">!</div>
              <h1 className="text-xl font-bold text-gray-800 mb-2">Failed to Load Data</h1>
              <p className="text-gray-600 mb-4">{loadError}</p>
              <button
                onClick={() => window.location.reload()}
                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
              >
                Retry
              </button>
            </div>
          </div>
        );
      }

      if (!dataLoaded) {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin w-12 h-12 border-4 border-green-600 border-t-transparent rounded-full mx-auto mb-4"></div>
              <p className="text-gray-600">Loading calculator data...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-100">
          <header className="bg-white shadow-sm">
            <div className="max-w-7xl mx-auto px-4 py-6">
              <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                  <h1 className="text-2xl font-bold text-gray-800">Responsible Products Calculator</h1>
                  <p className="text-gray-600 text-sm mt-1">Green Star - Responsible Products Framework</p>
                </div>
                <div className="flex gap-3">
                  <input
                    type="file"
                    ref={fileInputRef}
                    onChange={handleImport}
                    accept=".xlsx,.xls"
                    className="hidden"
                  />
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium text-gray-700"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Import Excel
                  </button>
                  <button
                    onClick={handleExport}
                    className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Export Excel
                  </button>
                </div>
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-4 py-6">
            <div className="bg-white rounded-xl shadow-lg mb-6">
              <Tabs activeTab={activeTab} onTabChange={setActiveTab} />
            </div>

            <CategoryPanel
              category={activeTab}
              data={categoryData[activeTab]}
              onDataChange={(data) => handleCategoryDataChange(activeTab, data)}
            />

            <div className="mt-8 p-4 bg-blue-50 rounded-xl text-sm text-blue-800">
              <strong>Note:</strong> This calculator determines if selected initiatives meet Good Practice or Best Practice tiers.
              A product may show "Tier not met" if the selected initiative(s) don't qualify, or "Not recognised" if the combination isn't in the database.
              It is really, really cool. 
            </div>
          </main>

          <footer className="max-w-7xl mx-auto px-4 py-6 text-center text-sm text-gray-500">
            Responsible Products Calculator v1.0 | Based on Green Star Responsible Products Framework
          </footer>
        </div>
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
